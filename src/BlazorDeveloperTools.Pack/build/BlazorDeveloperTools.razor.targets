<Project>
	<!-- Load our custom MSBuild task -->
	<UsingTask TaskName="BlazorDeveloperTools.Tasks.TransformRazorTask"
			   AssemblyFile="$(MSBuildThisFileDirectory)..\tools\BlazorDeveloperTools.Tasks.dll" />

	<PropertyGroup>
		<!-- Shadow directory where transformed files are placed -->
		<_BdtRoot>$(IntermediateOutputPath)blazordevtools\</_BdtRoot>
		<!-- Enable verbose logging for debugging -->
		<BdtVerbose Condition="'$(BdtVerbose)'==''">false</BdtVerbose>
	</PropertyGroup>

	<!-- Hook into the build to transform files -->
	<!-- Try multiple hook points to ensure we catch the RazorComponent items -->
	<Target Name="BlazorDeveloperTools_Transform"
			BeforeTargets="AssignRazorComponentTargetPaths"
			DependsOnTargets="ResolveReferences"
			Condition="'$(Configuration)'=='Debug' and '$(EnableAutomaticMarkers)'!='false'">

		<!-- Clean shadow directory -->
		<RemoveDir Directories="$(_BdtRoot)" />
		<MakeDir Directories="$(_BdtRoot)" />

		<!-- Check what we have -->
		<Message Importance="High" Text="BlazorDeveloperTools: Initial RazorComponent count = @(RazorComponent->Count())" />

		<!-- If RazorComponent is empty, manually populate it -->
		<ItemGroup Condition="@(RazorComponent->Count()) == 0">
			<RazorComponent Include="Components\**\*.razor" />
			<RazorComponent Include="**\*.razor" Exclude="bin\**;obj\**;Components\**\*.razor" />
		</ItemGroup>

		<Message Importance="High" Text="BlazorDeveloperTools: After discovery = @(RazorComponent->Count()) items" />
		<Message Importance="High" Condition="'$(BdtVerbose)'=='true'"
				 Text="Found: %(RazorComponent.Identity)" />

		<!-- Save originals -->
		<ItemGroup>
			<_BdtOriginal Include="@(RazorComponent)" />
		</ItemGroup>

		<!-- Create shadow copies -->
		<BlazorDeveloperTools.Tasks.TransformRazorTask
			Sources="@(_BdtOriginal)"
			IntermediateRoot="$(_BdtRoot)"
			ProjectDirectory="$(MSBuildProjectDirectory)"
			SkipUnderscoreFiles="true"
			OnlyRazorFiles="true" />

		<!-- Replace RazorComponent items -->
		<ItemGroup>
			<RazorComponent Remove="@(RazorComponent)" />
			<RazorComponent Include="$(_BdtRoot)**\*.razor" />
		</ItemGroup>

		<Message Importance="High" Text="BlazorDeveloperTools: Transformed @(RazorComponent->Count()) files" />
	</Target>

	<!-- Ensure paths are correct -->
	<Target Name="BlazorDeveloperTools_FixPaths"
			AfterTargets="AssignRazorComponentTargetPaths"
			BeforeTargets="PrepareForRazorCompile"
			Condition="'$(Configuration)'=='Debug' and '$(EnableAutomaticMarkers)'!='false'">

		<!-- Fix TargetPath to be relative -->
		<ItemGroup>
			<RazorComponentWithTargetPath>
				<TargetPath>$([System.String]::Copy('%(RazorComponentWithTargetPath.TargetPath)').Replace('obj\Debug\net8.0\blazordevtools\', '').Replace('obj/Debug/net8.0/blazordevtools/', ''))</TargetPath>
			</RazorComponentWithTargetPath>
		</ItemGroup>

		<Message Importance="High" Condition="'$(BdtVerbose)'=='true'"
				 Text="Fixed: %(RazorComponentWithTargetPath.Identity) -> %(RazorComponentWithTargetPath.TargetPath)" />
	</Target>

	<!-- Diagnostics -->
	<Target Name="BlazorDeveloperTools_Diagnostics"
			BeforeTargets="CoreCompile"
			Condition="'$(Configuration)'=='Debug' and '$(EnableAutomaticMarkers)'!='false' and '$(BdtVerbose)'=='true'">

		<Message Importance="High" Text="===== BlazorDeveloperTools Diagnostics =====" />

		<ItemGroup>
			<_DiagAF Include="@(AdditionalFiles)" Condition="'%(AdditionalFiles.Kind)'=='RazorComponent'" />
		</ItemGroup>

		<Message Importance="High" Text="AdditionalFiles for Razor: @(_DiagAF->Count())" />

		<!-- Check if files actually exist -->
		<ItemGroup>
			<_ShadowCheck Include="$(_BdtRoot)**\*.razor" />
		</ItemGroup>
		<Message Importance="High" Text="Shadow files on disk: @(_ShadowCheck->Count())" />
	</Target>
</Project>