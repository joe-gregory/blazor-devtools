<Project>
	<!-- Load our custom MSBuild task -->
	<UsingTask TaskName="BlazorDeveloperTools.Tasks.TransformRazorTask"
			   AssemblyFile="$(MSBuildThisFileDirectory)..\tools\BlazorDeveloperTools.Tasks.dll" />

	<PropertyGroup>
		<!-- Shadow directory where transformed files are placed -->
		<_BdtRoot>$(IntermediateOutputPath)blazordevtools\</_BdtRoot>
		<!-- Enable verbose logging for debugging -->
		<BdtVerbose Condition="'$(BdtVerbose)'==''">false</BdtVerbose>
	</PropertyGroup>

	<!-- Hook into the build to transform files -->
	<!-- Try multiple hook points to ensure we catch the RazorComponent items -->
	<Target Name="BlazorDeveloperTools_Transform"
			BeforeTargets="AssignRazorComponentTargetPaths"
			DependsOnTargets="ResolveReferences"
			Condition="'$(Configuration)'=='Debug' and '$(EnableAutomaticMarkers)'!='false'">

		<!-- Clean shadow directory with error handling -->
		<RemoveDir Directories="$(_BdtRoot)" ContinueOnError="true" />
		<Delete Files="$(_BdtRoot)**\*.*" ContinueOnError="true" />
		<MakeDir Directories="$(_BdtRoot)" Condition="!Exists('$(_BdtRoot)')" />

		<!-- Check what we have -->
		<Message Importance="High" Text="BlazorDeveloperTools: Initial RazorComponent count = @(RazorComponent->Count())" />

		<!-- If RazorComponent is empty, manually populate it -->
		<ItemGroup Condition="@(RazorComponent->Count()) == 0">
			<RazorComponent Include="Components\**\*.razor" />
			<RazorComponent Include="**\*.razor" Exclude="bin\**;obj\**;Components\**\*.razor" />
		</ItemGroup>

		<Message Importance="High" Text="BlazorDeveloperTools: After discovery = @(RazorComponent->Count()) items" />
		<Message Importance="High" Condition="'$(BdtVerbose)'=='true'"
				 Text="Found: %(RazorComponent.Identity)" />

		<!-- Save originals -->
		<ItemGroup>
			<_BdtOriginal Include="@(RazorComponent)" />
		</ItemGroup>

		<!-- Create shadow copies of .razor files with markers -->
		<BlazorDeveloperTools.Tasks.TransformRazorTask
			Sources="@(_BdtOriginal)"
			IntermediateRoot="$(_BdtRoot)"
			ProjectDirectory="$(MSBuildProjectDirectory)"
			SkipUnderscoreFiles="true"
			OnlyRazorFiles="true" />

		<!-- Copy associated files (.razor.css, .razor.cs, .razor.js) maintaining directory structure -->
		<ItemGroup>
			<!-- Discover all associated files - use a simpler approach -->
			<_BdtAllCssFiles Include="**\*.razor.css" Exclude="bin\**;obj\**" />
			<_BdtAllCsFiles Include="**\*.razor.cs" Exclude="bin\**;obj\**" />
			<_BdtAllJsFiles Include="**\*.razor.js" Exclude="bin\**;obj\**" />
		</ItemGroup>

		<Message Importance="High" Condition="@(_BdtAllCssFiles->Count()) > 0"
				 Text="BlazorDeveloperTools: Found @(_BdtAllCssFiles->Count()) CSS files to copy" />

		<!-- Copy files preserving full paths -->
		<Copy SourceFiles="@(_BdtAllCssFiles)"
			  DestinationFiles="@(_BdtAllCssFiles->'$(_BdtRoot)%(RecursiveDir)%(Filename)%(Extension)')"
			  SkipUnchangedFiles="false"
			  Condition="@(_BdtAllCssFiles->Count()) > 0" />

		<Copy SourceFiles="@(_BdtAllCsFiles)"
			  DestinationFiles="@(_BdtAllCsFiles->'$(_BdtRoot)%(RecursiveDir)%(Filename)%(Extension)')"
			  SkipUnchangedFiles="false"
			  Condition="@(_BdtAllCsFiles->Count()) > 0" />

		<Copy SourceFiles="@(_BdtAllJsFiles)"
			  DestinationFiles="@(_BdtAllJsFiles->'$(_BdtRoot)%(RecursiveDir)%(Filename)%(Extension)')"
			  SkipUnchangedFiles="false"
			  Condition="@(_BdtAllJsFiles->Count()) > 0" />

		<!-- Replace RazorComponent items -->
		<ItemGroup>
			<RazorComponent Remove="@(RazorComponent)" />
			<RazorComponent Include="$(_BdtRoot)**\*.razor" />
		</ItemGroup>

		<Message Importance="High" Text="BlazorDeveloperTools: Transformed @(RazorComponent->Count()) files" />
	</Target>

	<!-- Ensure paths are correct -->
	<Target Name="BlazorDeveloperTools_FixPaths"
			AfterTargets="AssignRazorComponentTargetPaths"
			BeforeTargets="PrepareForRazorCompile"
			Condition="'$(Configuration)'=='Debug' and '$(EnableAutomaticMarkers)'!='false'">

		<!-- Fix TargetPath to be relative -->
		<ItemGroup>
			<RazorComponentWithTargetPath>
				<TargetPath>$([System.String]::Copy('%(RazorComponentWithTargetPath.TargetPath)').Replace('obj\Debug\net8.0\blazordevtools\', '').Replace('obj/Debug/net8.0/blazordevtools/', ''))</TargetPath>
			</RazorComponentWithTargetPath>
		</ItemGroup>

		<Message Importance="High" Condition="'$(BdtVerbose)'=='true'"
				 Text="Fixed: %(RazorComponentWithTargetPath.Identity) -> %(RazorComponentWithTargetPath.TargetPath)" />
	</Target>

	<!-- Diagnostics -->
	<Target Name="BlazorDeveloperTools_Diagnostics"
			BeforeTargets="CoreCompile"
			Condition="'$(Configuration)'=='Debug' and '$(EnableAutomaticMarkers)'!='false' and '$(BdtVerbose)'=='true'">

		<Message Importance="High" Text="===== BlazorDeveloperTools Diagnostics =====" />

		<ItemGroup>
			<_DiagAF Include="@(AdditionalFiles)" Condition="'%(AdditionalFiles.Kind)'=='RazorComponent'" />
		</ItemGroup>

		<Message Importance="High" Text="AdditionalFiles for Razor: @(_DiagAF->Count())" />

		<!-- Check if files actually exist -->
		<ItemGroup>
			<_ShadowCheck Include="$(_BdtRoot)**\*.razor" />
		</ItemGroup>
		<Message Importance="High" Text="Shadow files on disk: @(_ShadowCheck->Count())" />
	</Target>
</Project>