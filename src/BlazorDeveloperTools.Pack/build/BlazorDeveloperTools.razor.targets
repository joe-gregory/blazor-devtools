<Project>
	<!-- Load our custom MSBuild task -->
	<UsingTask TaskName="BlazorDeveloperTools.Tasks.TransformRazorTask"
			   AssemblyFile="$(MSBuildThisFileDirectory)..\tools\BlazorDeveloperTools.Tasks.dll" />

	<PropertyGroup>
		<!-- Shadow directory where transformed files are placed -->
		<_BdtRoot>$(IntermediateOutputPath)blazordevtools\</_BdtRoot>
		<!-- Enable verbose logging for debugging (set to true for diagnostics) -->
		<BdtVerbose Condition="'$(BdtVerbose)'==''">false</BdtVerbose>
	</PropertyGroup>

	<!-- Main transformation target - runs early in the build process -->
	<Target Name="BlazorDeveloperTools_TransformFiles"
			BeforeTargets="AssignRazorComponentTargetPaths"
			Condition="'$(Configuration)'=='Debug' and '$(EnableAutomaticMarkers)'!='false'">

		<!-- Clean the shadow directory to ensure fresh copies -->
		<RemoveDir Directories="$(_BdtRoot)" />
		<MakeDir Directories="$(_BdtRoot)" />

		<!-- Save original RazorComponent items -->
		<ItemGroup>
			<_BdtOriginalRazor Include="@(RazorComponent)" />
		</ItemGroup>

		<Message Importance="High" Text="BlazorDeveloperTools: Processing @(_BdtOriginalRazor->Count()) Razor files" />

		<!-- Run our transformation task to create shadow copies with injected markers -->
		<BlazorDeveloperTools.Tasks.TransformRazorTask
			Sources="@(_BdtOriginalRazor)"
			IntermediateRoot="$(_BdtRoot)"
			ProjectDirectory="$(MSBuildProjectDirectory)"
			SkipUnderscoreFiles="true"
			OnlyRazorFiles="true" />

		<!-- Clear original RazorComponent items -->
		<ItemGroup>
			<RazorComponent Remove="@(RazorComponent)" />
		</ItemGroup>

		<!-- Re-discover the shadow files with proper metadata -->
		<ItemGroup>
			<RazorComponent Include="$(_BdtRoot)**\*.razor" />
		</ItemGroup>

		<Message Importance="High" Text="BlazorDeveloperTools: Transformation complete" />

		<!-- Verbose diagnostics if enabled -->
		<Message Importance="High" Condition="'$(BdtVerbose)'=='true'"
				 Text="Shadow file: %(RazorComponent.Identity)" />
	</Target>

	<!-- Optional: Diagnostic output to verify the process -->
	<Target Name="BlazorDeveloperTools_Diagnostics"
			AfterTargets="ResolveRazorCompileInputs"
			BeforeTargets="CoreCompile"
			Condition="'$(Configuration)'=='Debug' and '$(EnableAutomaticMarkers)'!='false' and '$(BdtVerbose)'=='true'">

		<Message Importance="High" Text="===== BlazorDeveloperTools Diagnostics =====" />

		<!-- Check how many AdditionalFiles were created for Razor -->
		<ItemGroup>
			<_BdtRazorAF Include="@(AdditionalFiles)" Condition="'%(AdditionalFiles.Kind)'=='RazorComponent'" />
		</ItemGroup>

		<Message Importance="High" Text="Razor AdditionalFiles count: @(_BdtRazorAF->Count())" />
		<Message Importance="High" Text="UseRazorSourceGenerator: $(UseRazorSourceGenerator)" />

		<!-- List shadow files that were created -->
		<ItemGroup>
			<_BdtShadowFiles Include="$(_BdtRoot)**\*.razor" />
		</ItemGroup>

		<Message Importance="High" Text="Shadow files created: @(_BdtShadowFiles->Count())" />

		<!-- Debug: Show what each shadow file's path looks like -->
		<Message Importance="High" Condition="'$(BdtVerbose)'=='true'"
				 Text="Shadow exists: %(_BdtShadowFiles.Identity)" />
	</Target>
</Project>