<Project>
	<UsingTask TaskName="BlazorDeveloperTools.Tasks.TransformRazorTask"
			   AssemblyFile="$(MSBuildThisFileDirectory)..\tools\BlazorDeveloperTools.Tasks.dll" />

	<PropertyGroup>
		<EnableAutomaticMarkers Condition="'$(EnableAutomaticMarkers)' == ''">true</EnableAutomaticMarkers>
		<_BdtRoot>$(IntermediateOutputPath)blazordevtools\</_BdtRoot>
	</PropertyGroup>

	<!-- Loud ping so you know the targets imported -->
	<Target Name="BDT_Ping" BeforeTargets="CoreCompile">
		<Message Importance="High" Text="BDT: Targets imported. UseRazorSourceGenerator=$(UseRazorSourceGenerator)" />
	</Target>

	<!-- Unified swap for .razor components, regardless of SG setting -->
	<Target Name="BlazorDeveloperTools_ComponentSwap"
			AfterTargets="ComputeRazorComponentItems"
			BeforeTargets="ResolveRazorCompileInputs;RazorCoreGenerate"
			Condition="'$(Configuration)'=='Debug' and '$(EnableAutomaticMarkers)'=='true'">

		<RemoveDir Directories="$(_BdtRoot)" />

		<ItemGroup>
			<_OrigComp Include="@(RazorComponent)" />
		</ItemGroup>

		<Message Importance="High" Text="BDT: SG â€” RazorComponent count = @(_OrigComp->Count())" />
		<Message Importance="Low"  Text="BDT: SG â€” RazorComponent = @(_OrigComp, ', ')" />

		<BlazorDeveloperTools.Tasks.TransformRazorTask
			Sources="@(_OrigComp)"
			IntermediateRoot="$(_BdtRoot)"
			ProjectDirectory="$(MSBuildProjectDirectory)"
			SkipUnderscoreFiles="true"
			OnlyRazorFiles="true" />

		<ItemGroup>
			<RazorComponent Remove="@(RazorComponent)" />
			<RazorComponent Include="@(_OrigComp->'$(_BdtRoot)%(RecursiveDir)%(Filename)%(Extension)')">
				<RelativePath>%(_OrigComp.RelativePath)</RelativePath>
				<TargetPath>%(_OrigComp.TargetPath)</TargetPath>
				<Link>%(_OrigComp.Link)</Link>
				<RazorRootNamespace>%(_OrigComp.RazorRootNamespace)</RazorRootNamespace>
				<CopyToOutputDirectory>%(_OrigComp.CopyToOutputDirectory)</CopyToOutputDirectory>
				<DependentUpon>%(_OrigComp.DependentUpon)</DependentUpon>
				<LastGenOutput>%(_OrigComp.LastGenOutput)</LastGenOutput>
				<OriginalItemSpec>$(_BdtRoot)%(_OrigComp.RecursiveDir)%(_OrigComp.Filename)%(_OrigComp.Extension)</OriginalItemSpec>
			</RazorComponent>
		</ItemGroup>

		<!-- ðŸ”‘ Refresh the SG's inputs explicitly -->
		<ItemGroup>
			<AdditionalFiles Remove="@(AdditionalFiles)"
							Condition="'%(AdditionalFiles.Kind)'=='RazorComponent'" />
			<AdditionalFiles Include="@(RazorComponent)">
				<Kind>RazorComponent</Kind>
			</AdditionalFiles>
		</ItemGroup>

		<Message Importance="High" Text="BDT: SG â€” FINAL RazorComponent = @(RazorComponent, ', ')" />
	</Target>

</Project>
