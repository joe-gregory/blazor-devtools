<Project>

	<UsingTask TaskName="BlazorDeveloperTools.Tasks.TransformRazorTask"
			   AssemblyFile="$(MSBuildThisFileDirectory)..\tools\BlazorDeveloperTools.Tasks.dll" />

	<PropertyGroup>
		<EnableAutomaticMarkers Condition="'$(EnableAutomaticMarkers)' == ''">true</EnableAutomaticMarkers>
	</PropertyGroup>

	<!-- Run before Razor compiles; also hook CoreCompile as a safety net -->
	<Target Name="BlazorDeveloperTools_PreTransformRazor"
			BeforeTargets="RazorComponentGenerate;RazorCoreGenerate;RazorGenerate;CoreCompile"
			Condition="'$(Configuration)' == 'Debug' and '$(EnableAutomaticMarkers)' == 'true'">

		<PropertyGroup>
			<!-- Shadow root under obj -->
			<_BdtRoot>$(IntermediateOutputPath)blazordevtools\</_BdtRoot>
		</PropertyGroup>


		<!-- 0) Always start fresh to prevent stale injected content -->
		<RemoveDir Directories="$(_BdtRoot)" />

		<!-- 1) Gather Razor inputs from well-known item lists -->
		<ItemGroup>
			<_BdtInputs Include="@(RazorComponent)" />
			<_BdtInputs Include="@(RazorGenerate)" />
		</ItemGroup>

		<!-- 2) If none found, fallback to globbing the project (exclude bin/obj) -->
		<ItemGroup Condition="'@(_BdtInputs)' == ''">
			<_BdtInputs Include="$(MSBuildProjectDirectory)\**\*.razor"
						Exclude="$(MSBuildProjectDirectory)\**\bin\**;$(MSBuildProjectDirectory)\**\obj\**" />
		</ItemGroup>

		<!-- Diagnostics -->
		<Message Importance="High" Text="BlazorDevTools: found @(_BdtInputs->Count()) Razor inputs. Root=$(_BdtRoot)" />
		<Message Importance="Low"  Text="BlazorDevTools: inputs: @(_BdtInputs)" Condition="'@(_BdtInputs)' != ''" />

		<!-- 3) Transform (and pass-through underscore files) into obj/.../blazordevtools/... -->
		<BlazorDeveloperTools.Tasks.TransformRazorTask
			Sources="@(_BdtInputs)"
			IntermediateRoot="$(_BdtRoot)"
			ProjectDirectory="$(MSBuildProjectDirectory)"
			SkipUnderscoreFiles="false"
			OnlyRazorFiles="true" />

		<!-- 4) Swap Razor to compile our shadow copies, PRESERVING METADATA -->
		<!-- Capture originals to read their metadata -->
		<ItemGroup>
			<_BdtOrigRazorComponent Include="@(RazorComponent)" />
			<_BdtOrigRazorGenerate Include="@(RazorGenerate)" />
		</ItemGroup>

		<!-- Replace RazorComponent -->
		<ItemGroup>
			<RazorComponent Remove="@(_BdtOrigRazorComponent)" />
			<RazorComponent Include="@(_BdtOrigRazorComponent->'$(_BdtRoot)%(RecursiveDir)%(Filename)%(Extension)')">
				<RelativePath>%(_BdtOrigRazorComponent.RelativePath)</RelativePath>
				<TargetPath>%(_BdtOrigRazorComponent.TargetPath)</TargetPath>
				<Link>%(_BdtOrigRazorComponent.Link)</Link>
			</RazorComponent>
		</ItemGroup>

		<!-- Replace RazorGenerate -->
		<ItemGroup>
			<RazorGenerate Remove="@(_BdtOrigRazorGenerate)" />
			<RazorGenerate Include="@(_BdtOrigRazorGenerate->'$(_BdtRoot)%(RecursiveDir)%(Filename)%(Extension)')">
				<RelativePath>%(_BdtOrigRazorGenerate.RelativePath)</RelativePath>
				<TargetPath>%(_BdtOrigRazorGenerate.TargetPath)</TargetPath>
				<Link>%(_BdtOrigRazorGenerate.Link)</Link>
			</RazorGenerate>
		</ItemGroup>

		<Message Importance="High" Text="BlazorDevTools: shadow copies active from $(_BdtRoot)." />
	</Target>

</Project>
