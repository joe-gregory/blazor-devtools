<Project>

	<!-- Load our MSBuild task -->
	<UsingTask TaskName="BlazorDeveloperTools.Tasks.TransformRazorTask"
			   AssemblyFile="$(MSBuildThisFileDirectory)..\tools\BlazorDeveloperTools.Tasks.dll" />

	<PropertyGroup>
		<!-- Default ON in Debug -->
		<EnableAutomaticMarkers Condition="'$(EnableAutomaticMarkers)' == ''">true</EnableAutomaticMarkers>
	</PropertyGroup>

	<!-- Run BEFORE Razor consumes items; include CoreCompile as a safety net -->
	<Target Name="BlazorDeveloperTools_PreTransformRazor"
			BeforeTargets="ComputeRazorComponentItems;RazorComponentGenerate;RazorCoreGenerate;RazorGenerate;CoreCompile"
			Condition="'$(Configuration)' == 'Debug' and '$(EnableAutomaticMarkers)' == 'true'">

		<PropertyGroup>
			<_BdtRoot>$(IntermediateOutputPath)blazordevtools\</_BdtRoot>
		</PropertyGroup>

		<!-- Always start fresh -->
		<RemoveDir Directories="$(_BdtRoot)" />

		<!-- Gather what the SDK currently has -->
		<ItemGroup>
			<_SeenRazorComponent Include="@(RazorComponent)" />
			<_SeenRazorGenerate Include="@(RazorGenerate)" />
			<!-- Some SDKs populate only one of these. -->
		</ItemGroup>

		<!-- Pre-swap diagnostics -->
		<Message Importance="High" Text="BlazorDevTools: PRE-SWAP RazorComponent count = @(_SeenRazorComponent->Count())" />
		<Message Importance="High" Text="BlazorDevTools: PRE-SWAP RazorGenerate  count = @(_SeenRazorGenerate->Count())" />
		<Message Importance="Low"  Text="BlazorDevTools: RazorComponent = @(_SeenRazorComponent, ', ')" Condition="'@(_SeenRazorComponent)' != ''" />
		<Message Importance="Low"  Text="BlazorDevTools: RazorGenerate  = @(_SeenRazorGenerate,  ', ')" Condition="'@(_SeenRazorGenerate)'  != ''" />

		<!-- If neither list is populated (rare), glob .razor files as a fallback -->
		<ItemGroup Condition="'@(_SeenRazorComponent)' == '' and '@(_SeenRazorGenerate)' == ''">
			<_FallbackInputs Include="$(MSBuildProjectDirectory)\**\*.razor"
							 Exclude="$(MSBuildProjectDirectory)\**\bin\**;$(MSBuildProjectDirectory)\**\obj\**" />
		</ItemGroup>

		<!-- Transform originals (whichever set we have) into the shadow root -->
		<BlazorDeveloperTools.Tasks.TransformRazorTask
			Sources="@(RazorComponent);@(RazorGenerate);@(_FallbackInputs)"
			IntermediateRoot="$(_BdtRoot)"
			ProjectDirectory="$(MSBuildProjectDirectory)"
			SkipUnderscoreFiles="false"
			OnlyRazorFiles="true" />

		<!-- ===== SWAP: RazorComponent → shadow ===== -->
		<ItemGroup Condition="'@(_SeenRazorComponent)' != ''">
			<_BdtOrigRazorComponent Include="@(RazorComponent)" />
			<RazorComponent Remove="@(_BdtOrigRazorComponent)" />
			<RazorComponent Include="@(_BdtOrigRazorComponent->'$(_BdtRoot)%(RecursiveDir)%(Filename)%(Extension)')">
				<!-- preserve important metadata -->
				<RelativePath>%(_BdtOrigRazorComponent.RelativePath)</RelativePath>
				<TargetPath>%(_BdtOrigRazorComponent.TargetPath)</TargetPath>
				<Link>%(_BdtOrigRazorComponent.Link)</Link>
				<OriginalItemSpec>$(_BdtRoot)%(_BdtOrigRazorComponent.RecursiveDir)%(_BdtOrigRazorComponent.Filename)%(_BdtOrigRazorComponent.Extension)</OriginalItemSpec>
				<RazorRootNamespace>%(_BdtOrigRazorComponent.RazorRootNamespace)</RazorRootNamespace>
				<RazorSourceGenerator>%(_BdtOrigRazorComponent.RazorSourceGenerator)</RazorSourceGenerator>
				<CopyToOutputDirectory>%(_BdtOrigRazorComponent.CopyToOutputDirectory)</CopyToOutputDirectory>
				<DependentUpon>%(_BdtOrigRazorComponent.DependentUpon)</DependentUpon>
				<LastGenOutput>%(_BdtOrigRazorComponent.LastGenOutput)</LastGenOutput>
			</RazorComponent>
		</ItemGroup>

		<!-- ===== SWAP: RazorGenerate → shadow ===== -->
		<ItemGroup Condition="'@(_SeenRazorGenerate)' != ''">
			<_BdtOrigRazorGenerate Include="@(RazorGenerate)" />
			<RazorGenerate Remove="@(_BdtOrigRazorGenerate)" />
			<RazorGenerate Include="@(_BdtOrigRazorGenerate->'$(_BdtRoot)%(RecursiveDir)%(Filename)%(Extension)')">
				<!-- preserve important metadata -->
				<RelativePath>%(_BdtOrigRazorGenerate.RelativePath)</RelativePath>
				<TargetPath>%(_BdtOrigRazorGenerate.TargetPath)</TargetPath>
				<Link>%(_BdtOrigRazorGenerate.Link)</Link>
				<RazorRootNamespace>%(_BdtOrigRazorGenerate.RazorRootNamespace)</RazorRootNamespace>
				<RazorSourceGenerator>%(_BdtOrigRazorGenerate.RazorSourceGenerator)</RazorSourceGenerator>
				<CopyToOutputDirectory>%(_BdtOrigRazorGenerate.CopyToOutputDirectory)</CopyToOutputDirectory>
				<DependentUpon>%(_BdtOrigRazorGenerate.DependentUpon)</DependentUpon>
				<LastGenOutput>%(_BdtOrigRazorGenerate.LastGenOutput)</LastGenOutput>
			</RazorGenerate>
		</ItemGroup>

		<!-- Post-swap diagnostics -->
		<Message Importance="High" Text="BlazorDevTools: POST-SWAP RazorComponent → @(RazorComponent, ', ')" Condition="'@(_SeenRazorComponent)' != ''" />
		<Message Importance="High" Text="BlazorDevTools: POST-SWAP RazorGenerate  → @(RazorGenerate,  ', ')" Condition="'@(_SeenRazorGenerate)'  != ''" />
		<Message Importance="High" Text="BlazorDevTools: FINAL RazorComponent FullPaths = @(RazorComponent->'%(FullPath)')" />

		<Message Importance="High" Text="BlazorDevTools: shadow copies active from $(_BdtRoot)." />
	</Target>

</Project>
