@page "/order-builder"
@using AutoServerGlobal.Components.Pages.Order_Builder_Models
@inherits BlazorDevToolsComponentBase

<PageTitle>Order Builder - Performance Lab</PageTitle>

<h1>ğŸ›’ Cart</h1>
<p class="lead">Learn how to identify and fix one of the most common Blazor performance mistakes using Blazor Developer Tools.</p>

@* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SECTION 1: THE PROBLEM
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• *@
<div class="card mb-4 border-danger">
    <div class="card-header bg-danger text-white">
        <h4 class="mb-0">ğŸ› The Problem: Unnecessary Re-renders</h4>
    </div>
    <div class="card-body">
        <p>
            <strong>This is one of the most common performance mistakes Blazor developers make.</strong>
            When a parent component re-renders, <em>all</em> of its child components re-render tooâ€”even if their data hasn't changed.
        </p>

        <div class="row">
            <div class="col-md-6">
                <h6>The Scenario</h6>
                <p>
                    You have a list of product cards. When you update <strong>one</strong> product's quantity,
                    what happens to the <strong>other</strong> cards?
                </p>

                <pre class="bg-dark text-light p-3 rounded small"><code>@("@foreach (var product in Products)")
{
    &lt;ProductCard 
        Name="@("@product.Name")"
        Quantity="@("@product.Quantity")"
        QuantityChanged="@("@HandleChange")" /&gt;
}</code></pre>
            </div>
            <div class="col-md-6">
                <h6>What You Expect</h6>
                <p>Only the changed product card re-renders.</p>

                <h6>What Actually Happens</h6>
                <p class="text-danger"><strong>ALL product cards re-render!</strong> Even the ones whose data didn't change.</p>

                <p class="small text-muted">
                    With 10 products and a 50ms render time each, changing one quantity takes 500ms instead of 50ms.
                </p>
            </div>
        </div>
    </div>
</div>

@* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SECTION 2: INTERACTIVE DEMO
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• *@
<div class="card mb-4">
    <div class="card-header">
        <h4 class="mb-0">ğŸ§ª Interactive Demo</h4>
    </div>
    <div class="card-body">
        <div class="alert alert-info">
            <strong>ğŸ“Š Open Blazor Developer Tools</strong> (F12 â†’ Blazor tab) to see real-time metrics.
            Compare the <strong>Render Count</strong> between Basic and Optimized cards when you update any in their group. For non-optimized cards, changing quantity in one will re-render all of them. Optimized cards don't re-render unnecessarily.
        </div>

        @* Controls *@
        <div class="card bg-light mb-4">
            <div class="card-body">
                <h6>âš™ï¸ Controls</h6>
                <div class="d-flex flex-wrap gap-2">
                    <button class="btn btn-danger" @onclick="IncrementFirstBasic"
                            title="Increments Apples in the Basic section. Watch: ALL 4 Basic cards will re-render, but only 1 Optimized card will.">
                        +1 ğŸ Basic
                    </button>
                    <button class="btn btn-success" @onclick="IncrementFirstOptimized"
                            title="Increments Apples in the Optimized section. Watch: Only the Apples card re-renders. Others show increased False count in ShouldRender Stats.">
                        +1 ğŸ Optimized
                    </button>
                    <button class="btn btn-outline-primary" @onclick="RandomizeAllQuantities"
                            title="Changes all quantities randomly. Both sections will re-render all cards since all data changed.">
                        ğŸ² Randomize All
                    </button>
                    <button class="btn btn-outline-warning" @onclick="ResetAllQuantities"
                            title="Resets all quantities to 0.">
                        ğŸ”„ Reset
                    </button>
                    <button class="btn btn-outline-dark" @onclick="TriggerParentRerender"
                            title="Calls StateHasChanged() on this parent component WITHOUT changing any data. Basic cards will all re-render uselessly. Optimized cards will all skip rendering via ShouldRender().">
                        âš¡ Parent Re-render
                    </button>
                </div>

                @if (_lastActionMessage != null)
                {
                    <div class="alert alert-secondary mb-0 mt-3 py-2 small">
                        <strong>Last Action:</strong> @_lastActionMessage
                    </div>
                }
            </div>
        </div>

        @* Side by side comparison *@
        <div class="row">
            @* Basic (Anti-pattern) *@
            <div class="col-lg-6 mb-4">
                <div class="card border-danger h-100">
                    <div class="card-header bg-danger text-white">
                        <h5 class="mb-0">âŒ Basic (No Optimization)</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-2">
                            @foreach (var product in _basicProducts)
                            {
                                var p = product;
                                <div class="col-6">
                                    <ProductCardBasic ProductId="@p.Id"
                                                      Name="@p.Name"
                                                      Emoji="@p.Emoji"
                                                      Price="@p.Price"
                                                      Quantity="@p.Quantity"
                                                      QuantityChanged="@((int q) => UpdateBasicQuantity(p.Id, q))" />
                                </div>
                            }
                        </div>
                        <p class="small text-danger mt-3 mb-0">
                            <strong>In DevTools:</strong> All cards have the same <strong>Render Count</strong>
                        </p>
                    </div>
                </div>
            </div>

            @* Optimized *@
            <div class="col-lg-6 mb-4">
                <div class="card border-success h-100">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">âœ… Optimized (With ShouldRender)</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-2">
                            @foreach (var product in _optimizedProducts)
                            {
                                var p = product;
                                <div class="col-6">
                                    <ProductCardOptimized ProductId="@p.Id"
                                                          Name="@p.Name"
                                                          Emoji="@p.Emoji"
                                                          Price="@p.Price"
                                                          Quantity="@p.Quantity"
                                                          QuantityChanged="@((int q) => UpdateOptimizedQuantity(p.Id, q))" />
                                </div>
                            }
                        </div>
                        <p class="small text-success mt-3 mb-0">
                            <strong>In DevTools:</strong> Each card has different Render Count. Check <strong>ShouldRender Stats</strong>!
                        </p>
                    </div>
                </div>
            </div>
        </div>

        @* Cart Summary *@
        <div class="row">
            <div class="col-md-6 offset-md-3">
                <CartSummary Items="@_optimizedProducts" />
            </div>
        </div>
    </div>
</div>

@* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SECTION 3: HOW TO DETECT WITH DEVTOOLS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• *@
<div class="card mb-4 border-primary">
    <div class="card-header bg-primary text-white">
        <h4 class="mb-0">ğŸ” How to Detect This Problem with Blazor Developer Tools</h4>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <h6>Step 1: Open DevTools</h6>
                <p>Press F12 and navigate to the <strong>Blazor</strong> tab in your browser's developer tools.</p>

                <h6>Step 2: Find Your Components</h6>
                <p>Look for the component tree. Click on individual <code>ProductCardBasic</code> components.</p>

                <h6>Step 3: Check the Metrics</h6>
                <p>Look for these key metrics in the details panel:</p>
                <ul>
                    <li><strong>Render Count</strong> - How many times the component rendered</li>
                    <li><strong>Lifecycle Timing â†’ Calls column</strong> - Call counts for each lifecycle method</li>
                    <li><strong>ShouldRender Stats â†’ True / False</strong> - Renders allowed vs skipped</li>
                </ul>
            </div>
            <div class="col-md-6">
                <h6>ğŸš¨ Red Flags to Look For</h6>
                <div class="alert alert-danger">
                    <strong>Problem Indicator:</strong> Multiple sibling components all have the <em>same</em>
                    <strong>Render Count</strong> even though only one of them should have changed.
                </div>

                <h6>âœ… What Healthy Looks Like</h6>
                <div class="alert alert-success">
                    <strong>Optimized Indicator:</strong> Components have <em>different</em> Render Counts.
                    Unchanged components show increasing <strong>False</strong> count in ShouldRender Stats.
                </div>
            </div>
        </div>
    </div>
</div>

@* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SECTION 4: THE SOLUTION
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• *@
<div class="card mb-4 border-success">
    <div class="card-header bg-success text-white">
        <h4 class="mb-0">âœ… The Solution: Override ShouldRender()</h4>
    </div>
    <div class="card-body">
        <p>
            Blazor calls <code>ShouldRender()</code> before every render. By default, it returns <code>true</code>.
            Override it to return <code>false</code> when your component's output wouldn't change.
        </p>

        <div class="row">
            <div class="col-md-6">
                <h6>âŒ Before (ProductCardBasic)</h6>
                <pre class="bg-dark text-light p-3 rounded small"><code>@@code {
    [Parameter]
    public int Quantity { get; set; }
    
    // No ShouldRender override
    // Component re-renders EVERY time parent does
}</code></pre>
            </div>
            <div class="col-md-6">
                <h6>âœ… After (ProductCardOptimized)</h6>
                <pre class="bg-dark text-light p-3 rounded small"><code>@@code {
    [Parameter]
    public int Quantity { get; set; }
    
    private int _lastQuantity = -1;
    
    protected override bool ShouldRender()
    {
        // Only render if OUR data changed
        if (Quantity == _lastQuantity)
            return false; // Skip render!
        
        _lastQuantity = Quantity;
        return true;
    }
}</code></pre>
            </div>
        </div>

        <div class="alert alert-warning mt-3">
            <strong>âš ï¸ Important:</strong> Track <em>all</em> parameters that affect your component's output.
            If you have <code>Name</code>, <code>Price</code>, and <code>Quantity</code>, check all three!
        </div>
    </div>
</div>

@* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SECTION 5: WHY BLAZOR WORKS THIS WAY
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• *@
<div class="card mb-4 border-info">
    <div class="card-header bg-info text-white">
        <h4 class="mb-0">ğŸ”¬ Under the Hood: Why Blazor Works This Way</h4>
    </div>
    <div class="card-body">
        <h6>The Render Cycle</h6>
        <p>When you call <code>StateHasChanged()</code> or a parameter changes, Blazor follows this flow:</p>

        <div class="bg-light p-3 rounded mb-3">
            <ol class="mb-0">
                <li><strong>Parent calls StateHasChanged()</strong> â†’ Parent queued for re-render</li>
                <li><strong>Parent's BuildRenderTree runs</strong> â†’ Generates new virtual DOM</li>
                <li><strong>Blazor diffs the virtual DOM</strong> â†’ Finds child components</li>
                <li><strong>For each child: SetParametersAsync()</strong> â†’ Parameters passed to child</li>
                <li><strong>Child's ShouldRender() called</strong> â†’ Returns true by default</li>
                <li><strong>Child's BuildRenderTree runs</strong> â†’ Even if nothing changed!</li>
            </ol>
        </div>

        <div class="row">
            <div class="col-md-6">
                <h6>Why Doesn't Blazor Optimize This Automatically?</h6>
                <p>Blazor <em>could</em> compare parameters automatically, but:</p>
                <ul>
                    <li>Reference types (objects, lists) are compared by reference, not value</li>
                    <li>Deep comparison is expensive and error-prone</li>
                    <li>You know your component bestâ€”you decide what matters</li>
                </ul>
            </div>
            <div class="col-md-6">
                <h6>The Performance Math</h6>
                <table class="table table-sm small">
                    <thead>
                        <tr>
                            <th>Scenario</th>
                            <th>Basic</th>
                            <th>Optimized</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>4 products, 100ms render</td>
                            <td class="text-danger">400ms</td>
                            <td class="text-success">100ms</td>
                        </tr>
                        <tr>
                            <td>20 products, 100ms render</td>
                            <td class="text-danger">2000ms</td>
                            <td class="text-success">100ms</td>
                        </tr>
                        <tr>
                            <td>Complexity</td>
                            <td class="text-danger">O(n)</td>
                            <td class="text-success">O(1)</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <h6 class="mt-3">Other Optimization Strategies</h6>
        <div class="row">
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-body">
                        <h6 class="card-title">@@key Directive</h6>
                        <p class="small">Helps Blazor track list items efficiently during re-ordering.</p>
                        <code class="small">@@foreach (var item in Items)<br />{ &lt;Item @@key="item.Id" /&gt; }</code>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-body">
                        <h6 class="card-title">Virtualization</h6>
                        <p class="small">Only render visible items in long lists.</p>
                        <code class="small">&lt;Virtualize Items="Items"&gt;<br />...&lt;/Virtualize&gt;</code>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-body">
                        <h6 class="card-title">ImmutableData</h6>
                        <p class="small">Use immutable objects so reference comparison works.</p>
                        <code class="small">record Product(int Id, string Name);</code>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SECTION 6: DEVTOOLS WORKFLOW SUMMARY
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• *@
<div class="card mb-4">
    <div class="card-header">
        <h4 class="mb-0">ğŸ“‹ Blazor Developer Tools Workflow</h4>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-3 text-center mb-3">
                <div class="rounded-circle bg-primary text-white d-inline-flex align-items-center justify-content-center" style="width: 48px; height: 48px;">1</div>
                <h6 class="mt-2">Identify</h6>
                <p class="small">Notice UI sluggishness or check render counts in DevTools</p>
            </div>
            <div class="col-md-3 text-center mb-3">
                <div class="rounded-circle bg-primary text-white d-inline-flex align-items-center justify-content-center" style="width: 48px; height: 48px;">2</div>
                <h6 class="mt-2">Investigate</h6>
                <p class="small">Compare <strong>Render Count</strong> across sibling components</p>
            </div>
            <div class="col-md-3 text-center mb-3">
                <div class="rounded-circle bg-primary text-white d-inline-flex align-items-center justify-content-center" style="width: 48px; height: 48px;">3</div>
                <h6 class="mt-2">Implement</h6>
                <p class="small">Add <code>ShouldRender()</code> to skip unnecessary renders</p>
            </div>
            <div class="col-md-3 text-center mb-3">
                <div class="rounded-circle bg-primary text-white d-inline-flex align-items-center justify-content-center" style="width: 48px; height: 48px;">4</div>
                <h6 class="mt-2">Verify</h6>
                <p class="small">Confirm <strong>False</strong> count increases in ShouldRender Stats</p>
            </div>
        </div>
    </div>
</div>

@code {
    // Separate lists so changes in one section don't affect the other
    private List<Product> _basicProducts = Product.GetDefaultProducts();
    private List<Product> _optimizedProducts = Product.GetDefaultProducts();
    private string? _lastActionMessage;

    private static readonly Random _random = new();

    private void UpdateBasicQuantity(int productId, int newQuantity)
    {
        var product = _basicProducts.FirstOrDefault(p => p.Id == productId);
        if (product != null)
        {
            product.Quantity = newQuantity;
            _lastActionMessage = $"[Basic] Changed {product.Emoji} {product.Name} â†’ In DevTools: ALL Basic cards re-rendered";
        }
    }

    private void UpdateOptimizedQuantity(int productId, int newQuantity)
    {
        var product = _optimizedProducts.FirstOrDefault(p => p.Id == productId);
        if (product != null)
        {
            product.Quantity = newQuantity;
            _lastActionMessage = $"[Optimized] Changed {product.Emoji} {product.Name} â†’ In DevTools: Only this card re-rendered, others skipped";
        }
    }

    private void RandomizeAllQuantities()
    {
        foreach (var product in _basicProducts)
            product.Quantity = _random.Next(0, 10);
        foreach (var product in _optimizedProducts)
            product.Quantity = _random.Next(0, 10);
        _lastActionMessage = "Randomized all â†’ All cards re-render (data changed for all)";
    }

    private void ResetAllQuantities()
    {
        foreach (var product in _basicProducts)
            product.Quantity = 0;
        foreach (var product in _optimizedProducts)
            product.Quantity = 0;
        _lastActionMessage = "Reset all quantities to 0";
    }

    private void IncrementFirstBasic()
    {
        var first = _basicProducts.FirstOrDefault();
        if (first != null)
        {
            first.Quantity++;
            _lastActionMessage = $"[Basic] +1 {first.Emoji} â†’ In DevTools: ALL 4 Basic cards re-rendered (the problem!)";
        }
    }

    private void IncrementFirstOptimized()
    {
        var first = _optimizedProducts.FirstOrDefault();
        if (first != null)
        {
            first.Quantity++;
            _lastActionMessage = $"[Optimized] +1 {first.Emoji} â†’ In DevTools: Only Apples re-rendered, others show False +1 in ShouldRender Stats";
        }
    }

    private void TriggerParentRerender()
    {
        // StateHasChanged without changing data - shows the difference
        _lastActionMessage = "Parent re-rendered (no data changed) â†’ Basic: all re-render âŒ | Optimized: all skip (ShouldRender=false) âœ…";
        StateHasChanged();
    }
}
